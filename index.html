<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nube de Recuerdos</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #FEB195, #F67280, #C06C84, #6C5B7B, #355C7D);
            color: #333;
            margin: 0;
            padding: 20px 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            max-width: 800px;
            width: 95%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            padding: 50px 30px;
            border-radius: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: fadeIn 1.5s ease;
            margin-top: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 3.5em;
            font-weight: 700;
            background: linear-gradient(45deg, #F67280, #C06C84);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            text-align: center;
            color: #355C7D;
            font-size: 2.8em;
            margin: 0 0 10px;
        }

        .subtitle {
            text-align: center;
            font-size: 1.3em;
            color: #6C5B7B;
            margin-bottom: 40px;
            font-weight: 300;
        }

        .section {
            margin-bottom: 50px;
            padding: 30px;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.7);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: transform 0.4s ease;
        }

        .section:hover {
            transform: translateY(-10px);
        }

        h2 {
            font-family: 'Playfair Display', serif;
            color: #355C7D;
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(45deg, #F67280, #C06C84);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.4s ease;
            box-shadow: 0 6px 15px rgba(246, 114, 128, 0.3);
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            display: block;
        }

        button:hover {
            background: linear-gradient(45deg, #C06C84, #6C5B7B);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(192, 108, 132, 0.4);
        }

        input[type="file"], textarea {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            border: 2px solid #F67280;
            border-radius: 15px;
            font-size: 1.1em;
            background: rgba(255, 255, 255, 0.9);
            transition: border 0.3s;
        }

        input[type="file"]:focus, textarea:focus {
            border-color: #C06C84;
            outline: none;
        }

        #qr-reader {
            width: 100%;
            max-width: 450px;
            height: 350px;
            border: 4px dashed #F67280;
            border-radius: 25px;
            margin: 30px auto;
            display: none;
            background: #000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        #qr-result {
            text-align: center;
            font-weight: 500;
            color: #355C7D;
            font-size: 1.2em;
            margin: 20px 0;
        }

        #upload-status, #dedication-status {
            text-align: center;
            margin: 20px 0;
            font-weight: 500;
            font-size: 1.1em;
            color: #6C5B7B;
        }

        #album-link {
            text-align: center;
            margin: 40px 0;
        }

        #album-link a {
            color: #355C7D;
            font-size: 1.3em;
            text-decoration: none;
            font-weight: 500;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50px;
            display: inline-block;
            transition: background 0.3s;
        }

        #album-link a:hover {
            background: rgba(255, 255, 255, 0.9);
            color: #F67280;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="logo-text">Nube de Recuerdos ‚òÅ</div>
        <h1>¬°Bienvenidos!</h1>
        <p class="subtitle">Captura y guarda los mejores momentos del evento con amor</p>

        <div class="section">
            <h2>üì∏ Escanea el QR para compartir fotos y videos</h2>
            <button onclick="startQRScanner()">Escanear QR</button>
            <video id="qr-reader" playsinline></video>
            <canvas id="qr-canvas" style="display:none;"></canvas>
            <p id="qr-result"></p>

            <div id="share-media" style="display:none;">
                <input type="file" id="media-upload" accept="image/*,video/*" multiple>
                <button onclick="uploadMedia()">Subir a la Nube ‚òÅ</button>
                <p id="upload-status"></p>
            </div>
        </div>

        <div class="section">
            <h2>‚úçÔ∏è Dedica unas palabras al festejado</h2>
            <textarea id="dedication" rows="7" placeholder="Escribe aqu√≠ tu mensaje lleno de cari√±o..."></textarea>
            <button onclick="saveDedication()">Enviar dedicatoria</button>
            <p id="dedication-status"></p>
        </div>

        <div id="album-link">
            <a href="https://drive.google.com/drive/folders/1i8KMyO2fVKMoirFZ_u44C6CFesaxwndE" target="_blank">
                Ver todos los recuerdos en la nube ‚òÅ
            </a>
        </div>
    </div>

    <script>
        // URL DEL BACKEND (tu Web App)
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxWOK4FFyzemHpBENq87ySve-OYG87-ecjlqvSum56iZrqwKQVDEpAc94wJQBy8Cnm1/exec';

        // Convertir archivo a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
            });
        }

        // Subir fotos y videos
        async function uploadMedia() {
            const files = document.getElementById('media-upload').files;
            if (files.length === 0) {
                document.getElementById('upload-status').textContent = 'Selecciona al menos un archivo.';
                return;
            }

            const fileArray = [];
            for (let file of files) {
                const base64 = await fileToBase64(file);
                fileArray.push({
                    name: `${new Date().toISOString().slice(0,19).replace(/:/g,"-")}_${file.name}`,
                    mimeType: file.type || 'application/octet-stream',
                    data: base64.split(',')[1]
                });
            }

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ type: 'media', files: fileArray })
                });
                const result = await response.json();
                document.getElementById('upload-status').innerHTML = result.status === 'success' 
                    ? '¬°Fotos y videos subidos con √©xito! ‚úÖ' 
                    : 'Error al subir: ' + result.message;
            } catch (err) {
                document.getElementById('upload-status').textContent = 'Fallo de red. Intenta de nuevo.';
            }
        }

        // Guardar dedicatoria como PDF elegante
        async function saveDedication() {
            const text = document.getElementById('dedication').value.trim();
            if (!text) {
                document.getElementById('dedication-status').textContent = 'Escribe tu mensaje.';
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Dise√±o elegante con tu paleta
            doc.setFillColor(254, 177, 149); // #FEB195 peach
            doc.rect(0, 0, 210, 297, 'F');
            doc.setDrawColor(246, 114, 128); // #F67280 rosado
            doc.setLineWidth(4);
            doc.roundedRect(15, 15, 180, 267, 15, 15, 'S');
            doc.setDrawColor(246, 114, 128);
            doc.line(30, 50, 180, 50);
            doc.line(30, 240, 180, 240);
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(28);
            doc.setTextColor(53, 92, 125); // #355C7D azul
            doc.text('Dedicatoria Especial', 105, 40, {align: 'center'});
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(16);
            doc.setTextColor(53, 92, 125);
            const split = doc.splitTextToSize(text, 150);
            doc.text(split, 105, 70, {align: 'center'});
            doc.setFontSize(12);
            doc.setTextColor(108, 91, 123); // #6C5B7B p√∫rpura
            doc.text(`Enviado el ${new Date().toLocaleString('es-ES')}`, 105, 260, {align: 'center'});

            const pdfBase64 = doc.output('datauristring').split(',')[1];
            const fileName = `Dedicatoria_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.pdf`;

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ type: 'dedication', pdfData: pdfBase64, fileName: fileName })
                });
                const result = await response.json();
                document.getElementById('dedication-status').textContent = result.status === 'success' 
                    ? '¬°Dedicatoria guardada como PDF hermoso! ‚ù§Ô∏è' 
                    : 'Error al guardar: ' + result.message;
            } catch (err) {
                document.getElementById('dedication-status').textContent = 'Fallo de red.';
            }

            document.getElementById('dedication').value = '';
        }

        // Esc√°ner QR
        let video = document.getElementById('qr-reader');
        let canvas = document.getElementById('qr-canvas');
        let ctx = canvas.getContext('2d');
        let scanning = false;

        async function startQRScanner() {
            try {
                document.getElementById('qr-reader').style.display = 'block';
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.play();
                scanning = true;
                requestAnimationFrame(tick);
            } catch (err) {
                document.getElementById('qr-result').textContent = 'Error al acceder a la c√°mara. Permite el acceso.';
            }
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA && scanning) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    document.getElementById('qr-result').innerHTML = '<strong style="color:#355C7D">¬°QR detectado!</strong><br>Ya puedes compartir tus recuerdos.';
                    scanning = false;
                    video.srcObject.getTracks().forEach(track => track.stop());
                    document.getElementById('share-media').style.display = 'block';
                    document.getElementById('qr-reader').style.display = 'none';
                }
            }
            if (scanning) requestAnimationFrame(tick);
        }
    </script>
</body>
</html>